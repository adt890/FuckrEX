(function(){var authentication,chat,chatController,fuckr,loginController,profiles,profilesController,request,updateLocation,updateProfileController,xmpp;request=require("request");authentication=function($localStorage,$http,$rootScope,$q){var s4,uuid;s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};uuid=function(){return(""+s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()).toUpperCase()};$localStorage.deviceAuthentifier=$localStorage.deviceAuthentifier||uuid();$rootScope.profileId=$localStorage.profileId;return{authenticate:function(){return $q(function(resolve,reject){return $http.post("https://primus.grindr.com/2.0/session",{appName:"Grindr",appVersion:"2.2.3",authenticationToken:$localStorage.authenticationToken,deviceIdentifier:$localStorage.deviceAuthentifier,platformName:"Android",platformVersion:"19",profileId:$localStorage.profileId}).error(function(){$localStorage.authenticationToken=null;return reject("wrong token or no connection")}).success(function(data,status,headers,config){var sessionId;sessionId=headers()["session-id"];$http.defaults.headers.common["Session-Id"]=sessionId;$http.defaults.headers.common["Cookies"]="Session-Id="+sessionId;$rootScope.$emit("authenticated",data.xmppToken);$rootScope.authenticated=true;return resolve()})})},login:function(email,password){return $q(function(resolve,reject){var req;req=request.post("https://account.grindr.com/sessions?locale=en");req.form({email:email,password:password});return req.on("response",function(response){var redirection_link;redirection_link=response.headers.location;if(redirection_link){$localStorage.authenticationToken=redirection_link.split("authenticationToken=")[1].split("&")[0];$rootScope.profileId=$localStorage.profileId=parseInt(redirection_link.split("profileId=")[1]);return resolve()}else{return reject()}})})}}};angular.module("authentication",["ngStorage"]).factory("authentication",["$localStorage","$http","$rootScope","$q",authentication]);xmpp=require("simple-xmpp");chat=function($http,$localStorage,$rootScope,$q,profiles){var addMessage,createConversation,s4,uuid;s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};uuid=function(){return(""+s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()).toUpperCase()};$localStorage.conversations=$localStorage.conversations||{};$localStorage.sentImages=$localStorage.sentImages||[];createConversation=function(id){$localStorage.conversations[id]={id:id,messages:[]};return profiles.get(id).then(function(profile){return $localStorage.conversations[id].thumbnail=profile.profileImageMediaHash})};addMessage=function(message){var fromMe,id;if(parseInt(message.sourceProfileId)===$localStorage.profileId){fromMe=true;id=parseInt(message.targetProfileId)}else{fromMe=false;id=parseInt(message.sourceProfileId)}if(profiles.isBlocked(id)){return}if(message.type==="block"){profiles.blockedBy(id);if($localStorage.conversations[id]){delete $localStorage.conversations[id]}}else{if(!$localStorage.conversations[id]){createConversation(id)}$localStorage.conversations[id].lastTimeActive=message.timestamp;message=function(){switch(message.type){case"text":return{text:message.body};case"location":return{text:"*SENT LOCATION*"};case"image":return{image:angular.fromJson(message.body).imageHash};default:return{text:message.type+" "+message.body}}}();message.fromMe=fromMe;$localStorage.conversations[id].messages.push(message)}return $rootScope.$broadcast("new_message")};$rootScope.$on("authenticated",function(event,token){xmpp.connect({jid:""+$localStorage.profileId+"@chat.grindr.com",password:token,host:"chat.grindr.com",preferred:"PLAIN",disallowTLS:true});xmpp.on("online",function(data){chat.connected=true;return $http.get("https://primus.grindr.com/2.0/undeliveredChatMessages").then(function(response){data={messageIds:[]};_(response.data).sortBy(function(message){return message.timestamp}).forEach(function(message){addMessage(message);return data.messageIds.push(message.messageId)});if(data.messageIds.length>0){return $http.post("https://primus.grindr.com/2.0/confirmChatMessagesDelivered",data)}})});xmpp.conn.on("stanza",function(stanza){var message;if(stanza.is("message")){message=angular.fromJson(stanza.getChildText("body"));return addMessage(message)}});return xmpp.on("error",function(message){$rootScope.chatError=true;return alert("chat error: "+message)})});return{send:function(text,to){var message;message={targetProfileId:String(to),type:"text",messageId:uuid(),timestamp:Date.now(),sourceDisplayName:"",sourceProfileId:String($localStorage.profileId),body:text};xmpp.send(""+to+"@chat.grindr.com",angular.toJson(message));return addMessage(message)},getConversation:function(id){return $localStorage.conversations[id]},lastestConversations:function(){return _.sortBy($localStorage.conversations,function(conversation){return-conversation.lastTimeActive})},block:function(id){if($localStorage.conversations[id]){delete $localStorage.conversations[id]}return profiles.block(id)}}};angular.module("chat",["ngStorage","profiles"]).factory("chat",["$http","$localStorage","$rootScope","$q","profiles",chat]);profiles=function($http,$q,$rootScope){var blocked,profileCache;profileCache={};blocked=[];$rootScope.$on("authenticated",function(){return $http.get("https://primus.grindr.com/2.0/blocks").then(function(response){return blocked=_.intersection(response.data.blockedBy,response.data.blocking)})});return{nearby:function(params){var deferred;deferred=$q.defer();$http.post("https://primus.grindr.com/2.0/nearbyProfiles",params).then(function(response){var profile,_i,_len;profiles=_.reject(response.data.profiles,function(profile){return _.contains(blocked,profile.profileId)});for(_i=0,_len=profiles.length;_i<_len;_i++){profile=profiles[_i];if(!profileCache[profile.profileId]){profileCache[profile.profileId]=profile}}return deferred.resolve(profiles)});return deferred.promise},get:function(id){var deferred;if(profileCache[id]){return $q.when(profileCache[id])}else{deferred=$q.defer();$http.post("https://primus.grindr.com/2.0/getProfiles",{targetProfileIds:[id]}).then(function(response){return deferred.resolve(response.data[0])});return deferred.promise}},blockedBy:function(id){blocked.push(id);return delete profileCache[id]},block:function(id){this.blockedBy(id);return $http.post("https://primus.grindr.com/2.0/blockProfiles",{targetProfileIds:[id]})},isBlocked:function(id){return _.contains(blocked,id)}}};angular.module("profiles",[]).factory("profiles",["$http","$q","$rootScope",profiles]);updateLocation=function($rootScope,$http,$localStorage,$interval){return $rootScope.$on("authenticated",function(){return $interval(function(){return $http.put("https://primus.grindr.com/2.0/location",{lat:$localStorage.grindrParams.lat,lon:$localStorage.grindrParams.lon,profileId:$localStorage.profileId})},6e4)})};angular.module("updateLocation",[]).service("updateLocation",["$rootScope","$http","$localStorage","$interval",updateLocation]);chatController=function($scope,$routeParams,$location,chat){$scope.lastestConversations=chat.lastestConversations();$scope.open=function(id){$scope.conversationId=id;return $scope.conversation=chat.getConversation(id)};if($routeParams.id){$scope.open($routeParams.id)}$scope.$on("new_message",function(){$scope.conversation=chat.getConversation($scope.conversationId);return $scope.lastestConversations=chat.lastestConversations()});$scope.send=function(){chat.send($scope.message,$scope.conversationId);return $scope.message=""};return $scope.block=function(){if(confirm("Sure you want to block him?")){chat.block($scope.conversationId);return $location.path("/chat/")}}};angular.module("chatController",["ngRoute","chat"]).controller("chatController",["$scope","$routeParams","$location","chat",chatController]);loginController=function($scope,$location,authentication){$scope.login=function(){return authentication.login($scope.email,$scope.password).then(function(){return authentication.authenticate().then(function(){return $location.path("/profiles/")})},function(){return $scope.email=$scope.password=""})};return $scope.tip=function(){return alert("Please sign up using popup window and close it when the 'Create Account' button fades.")}};angular.module("loginController",["authentication"]).controller("loginController",["$scope","$location","authentication",loginController]);profilesController=function($scope,$interval,$localStorage,$routeParams,profiles){var autocomplete;$scope.$storage=$localStorage.$default({location:"San Francisco, CA",grindrParams:{lat:37.7833,lon:-122.4167,filter:{ageMinimum:18,ageMaximum:40,photoOnly:true,onlineOnly:false,page:1,quantity:150}}});$scope.refresh=function(){return profiles.nearby($scope.$storage.grindrParams).then(function(profiles){return $scope.nearbyProfiles=profiles})};$scope.refresh();$interval($scope.refresh,6e4);autocomplete=new google.maps.places.Autocomplete(document.getElementById("location"));google.maps.event.addListener(autocomplete,"place_changed",function(){var place;place=autocomplete.getPlace();if(place.geometry){$scope.$storage.grindrParams.lat=place.geometry.location.lat();$scope.$storage.grindrParams.lon=place.geometry.location.lng();return $scope.refresh()}});$scope.open=function(id){return profiles.get(id).then(function(profile){return $scope.profile=profile})};if($routeParams.id){return $scope.open(parseInt($routeParams.id))}};angular.module("profilesController",["ngRoute","ngStorage","profiles"]).controller("profilesController",["$scope","$interval","$localStorage","$routeParams","profiles",profilesController]);updateProfileController=function($scope,$http,$rootScope,profiles){profiles.get($rootScope.profileId,function(profile){return $scope.profile=profile});return updateAttribute(attribute)(function(){var data;data={};data[attribute]=$scope.profile[attribute];return $http.put("https://primus.grindr.com/2.0/profile",data)})};angular.module("updateProfileController",[]).controller("updateProfileController",["$scope","$http","$rootScope","profiles",updateProfileController]);fuckr=angular.module("fuckr",["ngRoute","profiles","profilesController","authentication","loginController","chat","chatController","updateLocation"]);fuckr.config(["$httpProvider","$routeProvider",function($httpProvider,$routeProvider){var name,route,_i,_len,_ref,_results;$httpProvider.defaults.headers.common.Accept="*/*";_ref=["/profiles/:id?","/chat/:id?","/login","/updateProfile"];_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){route=_ref[_i];name=route.split("/")[1];_results.push($routeProvider.when(route,{templateUrl:"views/"+name+".html",controller:""+name+"Controller"}))}return _results}]);fuckr.run(["$location","$injector","authentication",function($location,$injector,authentication){var factory,_i,_len,_ref;_ref=["profiles","chat","updateLocation"];for(_i=0,_len=_ref.length;_i<_len;_i++){factory=_ref[_i];$injector.get(factory)}return authentication.authenticate().then(function(){return $location.path("/profiles/")},function(){return $location.path("/login")})}])}).call(this);